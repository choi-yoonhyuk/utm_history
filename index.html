<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM 생성 이력 보기</title> <style>
        body { font-family: sans-serif; margin: 20px; font-size: 14px; }
        .button-container { margin-bottom: 20px; text-align: right; } 
        .button-container button { padding: 8px 15px; font-size: 0.9em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        .button-container button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background-color: #f0f0f0; position: sticky; top: 0; z-index: 1;}
        h1 { margin-top: 0; }
        #loadingStatus { font-style: italic; color: #777; margin-bottom: 15px; }
        #tableContainerWrapper { max-height: 70vh; overflow-y: auto; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <div class="button-container">
        <button onclick="location.href='https://choi-yoonhyuk.github.io/source_medium_drop/'">UTM 빌더로 이동</button> 
    </div>

    <h1>UTM 생성 이력</h1> <p id="loadingStatus">데이터 로딩 중...</p>
    <div id="tableContainerWrapper">
        <div id="optionsTableContainer"> 
            </div>
    </div>

    <script>
        // 1. UTM 생성 이력이 담긴 CSV 또는 JSON 파일의 URL
        //    이전에는 옵션 마스터 시트 CSV URL이었지만, 이제 "생성 이력" 데이터 소스를 가리켜야 합니다.
        //    만약 n8n-builder.json을 직접 사용한다면, 그 raw URL을 넣어야 하고, 파싱 로직도 JSON에 맞게 수정해야 합니다.
        //    여기서는 여전히 CSV를 가져온다고 가정하고, 그 CSV가 "생성 이력" 형태라고 가정합니다.
        const HISTORY_DATA_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1831366188&single=true&output=csv'; 
        // 예: 'https://docs.google.com/spreadsheets/d/e/2PACX-1v.../pub?gid=HISTORY_SHEET_GID&single=true&output=csv'
        // 또는, 만약 GitHub의 n8n-builder.json을 CSV처럼 파싱할 수 있는 형태로 제공한다면 그 URL.
        // 하지만 n8n-builder.json은 JSON 파일이므로, 아래 fetch 후 .text() 대신 .json()을 쓰고,
        // createTableFromCsv 대신 createTableFromJsonArray 같은 함수가 필요합니다.

        // --- 중요 ---
        // 지금부터는 이 페이지가 "생성 이력"을 보여준다고 가정하고, 
        // 데이터 소스가 CSV 형태의 이력이라고 가정하고 코드를 작성합니다.
        // 만약 HISTORY_JSON_URL ('n8n-builder.json')을 직접 사용하고 싶다면,
        // fetch 후 JSON 파싱 및 테이블 생성 로직을 JSON 배열에 맞게 수정해야 합니다.
        // 여기서는 일단 CSV를 그대로 보여주는 로직으로 수정합니다.

        document.addEventListener('DOMContentLoaded', async () => {
            const loadingStatusEl = document.getElementById('loadingStatus');
            const tableContainerEl = document.getElementById('optionsTableContainer');

            if (!HISTORY_DATA_CSV_URL || HISTORY_DATA_CSV_URL === 'https://docs.google.com/spreadsheets/d/e/2PACX-1vShcppno7HuVQbjoQzbaBMEvoBGt6atss9FI_-F3qSh_pzgtxw7A4NPo6Y2EYoll2y5_8wMt08X_oV0/pub?gid=1831366188&single=true&output=csv') {
                loadingStatusEl.textContent = "오류: 데이터 소스 CSV URL이 설정되지 않았습니다.";
                loadingStatusEl.style.color = "red";
                return;
            }
            
            try {
                loadingStatusEl.textContent = "생성 이력 로딩 중...";
                const response = await fetch(HISTORY_DATA_CSV_URL, {
                    cache: 'no-cache' 
                }); 

                if (!response.ok) {
                    throw new Error(`생성 이력 CSV 로드 실패 (상태 코드: ${response.status})`);
                }

                const csvDataText = await response.text(); 
                
                if (!csvDataText.trim()) { 
                    loadingStatusEl.textContent = "생성 이력 데이터가 비어있거나 가져올 수 없습니다.";
                    tableContainerEl.innerHTML = '<p>표시할 이력이 없습니다.</p>';
                    return;
                }

                const tableElement = createSimpleTableFromCsv(csvDataText); // 함수 이름 변경
                tableContainerEl.innerHTML = ''; 
                tableContainerEl.appendChild(tableElement); 
                loadingStatusEl.style.display = 'none'; 

            } catch (error) {
                console.error("생성 이력 로딩 또는 표시 오류:", error);
                loadingStatusEl.textContent = `오류: ${error.message}`;
                loadingStatusEl.style.color = "red";
                tableContainerEl.innerHTML = '<p>생성 이력을 불러오는 데 실패했습니다. 개발자 콘솔(F12)을 확인해주세요.</p>';
            }
        });

        // CSV 텍스트를 HTML 테이블 요소로 단순 변환하는 함수 (필터링 최소화)
        function createSimpleTableFromCsv(csvDataText) {
            const lines = csvDataText.split(/\r?\n/).filter(line => line.trim() !== ""); 
            const table = document.createElement('table');

            if (lines.length === 0) {
                const tr = table.insertRow();
                const td = tr.insertCell();
                td.textContent = "표시할 데이터가 없습니다 (CSV 비어있음).";
                return table;
            }

            // 첫 번째 줄을 헤더로 사용
            const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            // 두 번째 줄부터 데이터 행으로 사용
            const tbody = table.createTBody();
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i]; 
                // if (line.trim() === "") continue; // 이미 filter에서 처리

                const cells = line.split(',').map(cell => cell.replace(/^"|"$/g, '').trim());
                const tr = tbody.insertRow();
                
                for (let j = 0; j < headers.length; j++) { 
                    const td = tr.insertCell();
                    td.textContent = cells[j] !== undefined ? cells[j] : ""; 
                }
            }
            return table;
        }
    </script>
</body>
</html>